---
- name: Add Kubernetes APT repository key
  ansible.builtin.apt_key:
    url: https://pkgs.k8s.io/core:/stable:/v1.33/deb/Release.key
    state: present

- name: Add Kubernetes APT repository
  ansible.builtin.apt_repository:
    repo: "deb https://pkgs.k8s.io/core:/stable:/v1.33/deb/ /"
    state: present

- name: Install containerd
  ansible.builtin.package:
    name: containerd
    state: present

- name: Create containerd configuration directory
  ansible.builtin.file:
    path: /etc/containerd
    state: directory
    mode: "0755"

- name: Generate containerd configuration
  ansible.builtin.command: containerd config default
  register: kubernetes_containerd_config
  changed_when: false

- name: Modify containerd configuration (enable systemd cgroups)
  ansible.builtin.set_fact:
    kubernetes_containerd_config_modified: "{{ kubernetes_containerd_config.stdout | regex_replace('SystemdCgroup = false', 'SystemdCgroup = true') }}"

- name: Write containerd configuration
  ansible.builtin.copy:
    content: "{{ kubernetes_containerd_config_modified }}"
    dest: /etc/containerd/config.toml
    mode: "0644"
    owner: root
    group: root
    backup: true
  register: kubernetes_containerd_config_written
  changed_when: kubernetes_containerd_config_written.diff | default([]) | length > 0
  notify:
    - Prompt for containerd restart
    - Restart containerd

- name: Install Kubernetes packages
  ansible.builtin.package:
    name:
      - kubelet={{ kubernetes_version }}
      - kubeadm={{ kubernetes_version }}
      - kubectl={{ kubernetes_version }}
    state: present

- name: Hold Kubernetes packages
  ansible.builtin.dpkg_selections:
    name: "{{ item }}"
    selection: hold
  loop:
    - kubelet
    - kubeadm
    - kubectl

- name: Configure kubelet node IP
  ansible.builtin.lineinfile:
    path: /etc/default/kubelet
    regexp: "^KUBELET_EXTRA_ARGS="
    line: 'KUBELET_EXTRA_ARGS="--node-ip={{ wireguard_ip }}"'
    mode: "0644"
    owner: root
    group: root
    create: true
  notify: Restart kubelet
  when: inventory_hostname in groups['workers']

- name: Configure kubelet node IP for control plane
  ansible.builtin.lineinfile:
    path: /etc/default/kubelet
    regexp: "^KUBELET_EXTRA_ARGS="
    line: 'KUBELET_EXTRA_ARGS="--node-ip={{ local_ip }}"'
    mode: "0644"
    owner: root
    group: root
    create: true
  notify: Restart kubelet
  when: inventory_hostname in groups['control_plane']

- name: Enable and start services
  ansible.builtin.systemd:
    name: "{{ item }}"
    enabled: true
    state: started
  loop:
    - containerd
    - kubelet
