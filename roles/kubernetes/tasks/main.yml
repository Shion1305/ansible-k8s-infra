---
- name: Add Kubernetes APT repository key
  ansible.builtin.apt_key:
    url: https://pkgs.k8s.io/core:/stable:/v1.33/deb/Release.key
    state: present

- name: Add Kubernetes APT repository
  ansible.builtin.apt_repository:
    repo: "deb https://pkgs.k8s.io/core:/stable:/v1.33/deb/ /"
    state: present

- name: Install containerd
  ansible.builtin.package:
    name: containerd
    state: present

- name: Create containerd configuration directory
  ansible.builtin.file:
    path: /etc/containerd
    state: directory
    mode: "0755"

- name: Generate containerd configuration
  ansible.builtin.command: containerd config default
  register: kubernetes_containerd_config
  changed_when: false

- name: Write containerd configuration
  ansible.builtin.copy:
    content: "{{ kubernetes_containerd_config.stdout }}"
    dest: /etc/containerd/config.toml
    mode: "0644"
    owner: root
    group: root
    backup: true
  register: kubernetes_containerd_config_written

- name: Enable systemd cgroups in containerd
  ansible.builtin.lineinfile:
    path: /etc/containerd/config.toml
    regexp: "^\\s*SystemdCgroup = false"
    line: "            SystemdCgroup = true"
  register: kubernetes_containerd_systemd_cgroup

- name: Prompt for containerd restart confirmation
  ansible.builtin.pause:
    prompt: "Containerd configuration changed on {{ inventory_hostname }}. Do you want to restart containerd? (yes/no)"
  register: kubernetes_containerd_restart_confirm
  when: kubernetes_containerd_config_written.changed or kubernetes_containerd_systemd_cgroup.changed
  run_once: false

- name: Restart containerd if confirmed
  ansible.builtin.systemd:
    name: containerd
    state: restarted
  when: >
    (kubernetes_containerd_config_written.changed or kubernetes_containerd_systemd_cgroup.changed)
    and kubernetes_containerd_restart_confirm.user_input | default('no') | lower in ['yes', 'y']

- name: Install Kubernetes packages
  ansible.builtin.package:
    name:
      - kubelet={{ kubernetes_version }}
      - kubeadm={{ kubernetes_version }}
      - kubectl={{ kubernetes_version }}
    state: present

- name: Hold Kubernetes packages
  ansible.builtin.dpkg_selections:
    name: "{{ item }}"
    selection: hold
  loop:
    - kubelet
    - kubeadm
    - kubectl

- name: Configure kubelet node IP
  ansible.builtin.lineinfile:
    path: /etc/default/kubelet
    regexp: "^KUBELET_EXTRA_ARGS="
    line: 'KUBELET_EXTRA_ARGS="--node-ip={{ wireguard_ip }}"'
    mode: "0644"
    owner: root
    group: root
    create: true
  notify: Restart kubelet
  when: inventory_hostname in groups['workers']

- name: Configure kubelet node IP for control plane
  ansible.builtin.lineinfile:
    path: /etc/default/kubelet
    regexp: "^KUBELET_EXTRA_ARGS="
    line: 'KUBELET_EXTRA_ARGS="--node-ip={{ local_ip }}"'
    mode: "0644"
    owner: root
    group: root
    create: true
  notify: Restart kubelet
  when: inventory_hostname in groups['control_plane']

- name: Enable and start services
  ansible.builtin.systemd:
    name: "{{ item }}"
    enabled: true
    state: started
  loop:
    - containerd
    - kubelet
