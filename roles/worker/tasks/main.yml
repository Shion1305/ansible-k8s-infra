---
# UFW firewall configuration is now handled in the main site.yml playbook
# This avoids duplication and ensures consistent firewall management

- name: Add DNS override for WireGuard routing
  ansible.builtin.lineinfile:
    path: /etc/hosts
    regexp: "^.*k8s\\.shion1305\\.com.*$"
    line: "{{ hostvars[groups['control_plane'][0]]['wireguard_ip'] }} {{ hostvars[groups['control_plane'][0]]['ansible_host'] }}"
    backup: true

- name: Clean up old CNI network interfaces
  ansible.builtin.shell: |
    for bridge in cni0 docker0 flannel.1; do
      if ip link show $bridge >/dev/null 2>&1; then
        echo "Removing bridge: $bridge"
        ip link delete $bridge
      fi
    done
  register: worker_bridge_cleanup
  changed_when: "'Removing bridge:' in worker_bridge_cleanup.stdout"
  failed_when: false

- name: Remove stale CNI network configuration
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop:
    - /etc/cni/net.d/10-flannel.conflist
    - /etc/cni/net.d/10-containerd-net.conflist
    - /var/lib/cni/networks
  failed_when: false

- name: Check if node is already joined
  ansible.builtin.stat:
    path: /etc/kubernetes/kubelet.conf
  register: worker_kubelet_conf_exists

- name: Join worker node to cluster
  ansible.builtin.command: "{{ control_plane_kubernetes_join_command }}"
  register: worker_join_result
  changed_when: "'This node has joined the cluster' in worker_join_result.stdout"
  when: not worker_kubelet_conf_exists.stat.exists and control_plane_kubernetes_join_command is defined

- name: Update kubelet configuration with node IP
  ansible.builtin.lineinfile:
    path: /var/lib/kubelet/kubeadm-flags.env
    regexp: "^KUBELET_KUBEADM_ARGS=.*"
    line: >
      KUBELET_KUBEADM_ARGS="--container-runtime-endpoint=unix:///var/run/containerd/containerd.sock
      --pod-infra-container-image=registry.k8s.io/pause:3.10 --node-ip={{ wireguard_ip }}"
    backup: true
  notify: restart kubelet

- name: Ensure kubelet is running
  ansible.builtin.systemd:
    name: kubelet
    state: started
    enabled: true
