---
# UFW firewall configuration is now handled in the main site.yml playbook
# This avoids duplication and ensures consistent firewall management
  
- name: Add DNS override for WireGuard routing
  lineinfile:
    path: /etc/hosts
    regexp: '^.*k8s\.shion1305\.com.*$'
    line: "{{ hostvars[groups['control_plane'][0]]['wireguard_ip'] }} {{ hostvars[groups['control_plane'][0]]['ansible_host'] }}"
    backup: yes
  
- name: Clean up old CNI network interfaces
  shell: |
    for bridge in cni0 docker0 flannel.1; do
      if ip link show $bridge >/dev/null 2>&1; then
        echo "Removing bridge: $bridge"
        ip link delete $bridge
      fi
    done
  ignore_errors: yes
  
- name: Remove stale CNI network configuration
  file:
    path: "{{ item }}"
    state: absent
  loop:
    - /etc/cni/net.d/10-flannel.conflist
    - /etc/cni/net.d/10-containerd-net.conflist
    - /var/lib/cni/networks
  ignore_errors: yes
  
- name: Check if node is already joined
  stat:
    path: /etc/kubernetes/kubelet.conf
  register: kubelet_conf_exists
  
- name: Join worker node to cluster
  command: "{{ kubernetes_join_command }}"
  when: not kubelet_conf_exists.stat.exists and kubernetes_join_command is defined
  
- name: Update kubelet configuration with node IP
  lineinfile:
    path: /var/lib/kubelet/kubeadm-flags.env
    regexp: '^KUBELET_KUBEADM_ARGS=.*'
    line: 'KUBELET_KUBEADM_ARGS="--container-runtime-endpoint=unix:///var/run/containerd/containerd.sock --pod-infra-container-image=registry.k8s.io/pause:3.10 --node-ip={{ wireguard_ip }}"'
    backup: yes
  notify: restart kubelet
  
- name: Ensure kubelet is running
  systemd:
    name: kubelet
    state: started
    enabled: yes

