[Interface]
Address = {{ wireguard_ip }}/24
{% if inventory_hostname in groups['control_plane'] %}
ListenPort = {{ wireguard_port }}
{% endif %}
PrivateKey = {{ wireguard_private_key }}

{% if inventory_hostname in groups['control_plane'] %}
# Worker nodes
{% for host in groups['workers'] %}
[Peer]
# {{ host }}
PublicKey = {{ hostvars[host]['wireguard_public_key'] }}
AllowedIPs = {{ hostvars[host]['wireguard_ip'] }}/32

{% endfor %}
{% else %}
# Control plane
[Peer]
PublicKey = {{ hostvars[groups['control_plane'][0]]['wireguard_public_key'] }}
Endpoint = {{ hostvars[groups['control_plane'][0]]['control_plane_public_ip'] | default(lookup('dig', hostvars[groups['control_plane'][0]]['ansible_host'])) }}:{{ hostvars[groups['control_plane'][0]]['wireguard_port'] }}
{% if inventory_hostname == 'cm4' %}
AllowedIPs = {{ wireguard_network }}
{% else %}
AllowedIPs = {{ hostvars[groups['control_plane'][0]]['wireguard_ip'] }}/32
{% endif %}
PersistentKeepalive = 25
{% endif %}

