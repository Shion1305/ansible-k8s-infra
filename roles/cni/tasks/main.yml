---
- name: Deploy Flannel CNI using kubectl
  ansible.builtin.command: kubectl apply -f https://github.com/flannel-io/flannel/releases/latest/download/kube-flannel.yml
  become_user: "{{ ansible_user }}"
  become: false
  register: cni_flannel_deployment
  changed_when: "'created' in cni_flannel_deployment.stdout or 'configured' in cni_flannel_deployment.stdout"

- name: Verify Flannel DaemonSet has been created
  ansible.builtin.shell: |
    set -o pipefail
    kubectl get daemonset -n kube-flannel kube-flannel-ds -o name 2>/dev/null || echo ""
  become_user: "{{ ansible_user }}"
  become: false
  register: cni_flannel_daemonset_exists
  retries: 10
  delay: 5
  until: cni_flannel_daemonset_exists.stdout != ""
  changed_when: false
  failed_when: false

- name: Configure Flannel to use WireGuard interface
  ansible.builtin.shell: |
    set -o pipefail
    # Check if --iface=wg0 is already in the args
    CURRENT_ARGS=$(kubectl get ds -n kube-flannel kube-flannel-ds \
      -o jsonpath='{.spec.template.spec.containers[0].args[*]}')
    if ! echo "$CURRENT_ARGS" | grep -q -- '--iface=wg0'; then
      kubectl patch daemonset kube-flannel-ds -n kube-flannel --type='json' \
        -p='[{"op": "add", "path": "/spec/template/spec/containers/0/args/-", "value": "--iface=wg0"}]'
      echo "Patched Flannel DaemonSet to use wg0 interface"
    else
      echo "Flannel DaemonSet already configured to use wg0 interface"
    fi
  become_user: "{{ ansible_user }}"
  become: false
  register: cni_flannel_iface_patch
  changed_when: "'Patched' in cni_flannel_iface_patch.stdout"

- name: Remove stale Flannel node annotations to force re-detection
  ansible.builtin.shell: |
    set -o pipefail
    for node in $(kubectl get nodes -o jsonpath='{.items[*].metadata.name}'); do
      # Check if node has old physical IP annotation
      public_ip=$(kubectl get node "$node" -o jsonpath='{.metadata.annotations.flannel\.alpha\.coreos\.com/public-ip}' 2>/dev/null || echo "")
      if [ -n "$public_ip" ] && ! echo "$public_ip" | grep -q '^10\.0\.0\.'; then
        echo "Removing stale annotation from $node (old IP: $public_ip)"
        kubectl annotate node "$node" flannel.alpha.coreos.com/public-ip- 2>/dev/null || true
        kubectl annotate node "$node" flannel.alpha.coreos.com/backend-data- 2>/dev/null || true
      fi
    done
  become_user: "{{ ansible_user }}"
  become: false
  when: cni_flannel_iface_patch is defined and cni_flannel_iface_patch.changed
  register: cni_flannel_annotation_cleanup
  changed_when: "'Removing stale annotation' in cni_flannel_annotation_cleanup.stdout"
  failed_when: false

- name: Wait for Flannel DaemonSet rollout after configuration
  ansible.builtin.command: kubectl rollout status daemonset/kube-flannel-ds -n kube-flannel --timeout=120s
  become_user: "{{ ansible_user }}"
  become: false
  when: cni_flannel_iface_patch is defined and cni_flannel_iface_patch.changed
  register: cni_flannel_rollout
  changed_when: false
  failed_when: false

- name: Wait for some Flannel pods to start appearing
  ansible.builtin.shell: |
    set -o pipefail
    kubectl get pods -n kube-flannel | grep -c kube-flannel || echo "0"
  become_user: "{{ ansible_user }}"
  become: false
  register: cni_flannel_pod_count
  retries: 15
  delay: 5
  until: cni_flannel_pod_count.stdout | int > 0
  changed_when: false
  failed_when: false

- name: Wait for all nodes to be ready
  ansible.builtin.shell: |
    set -o pipefail
    NOT_READY=$(kubectl get nodes --no-headers | grep -v Ready | wc -l)
    if [ "$NOT_READY" -eq "0" ]; then
      echo "All nodes are ready"
      kubectl get nodes
      exit 0
    else
      echo "Waiting for nodes to be ready - $NOT_READY nodes not ready"
      kubectl get nodes
      exit 1
    fi
  become_user: "{{ ansible_user }}"
  become: false
  register: cni_nodes_ready_status
  until: cni_nodes_ready_status.rc == 0
  retries: 60
  delay: 10
  changed_when: "'All nodes are ready' in cni_nodes_ready_status.stdout"
  failed_when: false

- name: Wait for CoreDNS pods to be ready
  ansible.builtin.shell: |
    set -o pipefail
    NOT_READY=$(kubectl get pods -n kube-system -l k8s-app=kube-dns --no-headers | grep -v Running | wc -l)
    if [ "$NOT_READY" -eq "0" ]; then
      echo "CoreDNS pods are ready"
      kubectl get pods -n kube-system -l k8s-app=kube-dns
      exit 0
    else
      echo "Waiting for CoreDNS pods - $NOT_READY pods not ready"
      kubectl get pods -n kube-system -l k8s-app=kube-dns
      exit 1
    fi
  become_user: "{{ ansible_user }}"
  become: false
  register: cni_coredns_status
  until: cni_coredns_status.rc == 0
  retries: 30
  delay: 10
  changed_when: "'CoreDNS pods are ready' in cni_coredns_status.stdout"
  failed_when: false

- name: Save Flannel logs for troubleshooting if needed
  ansible.builtin.shell: |
    mkdir -p /tmp/k8s-deployment-logs
    kubectl logs -n kube-flannel -l app=flannel --tail=100 > /tmp/k8s-deployment-logs/flannel.log 2>&1 || true
    echo "Logs saved to /tmp/k8s-deployment-logs/flannel.log"
  become_user: "{{ ansible_user }}"
  become: false
  changed_when: false
  failed_when: false

- name: Verify all CNI components are working correctly
  ansible.builtin.shell: |
    echo "=== Verifying CNI Components ==="
    echo "Checking Flannel pods:"
    kubectl get pods -n kube-flannel -o wide
    echo "\nChecking CoreDNS pods:"
    kubectl get pods -n kube-system -l k8s-app=kube-dns -o wide
    echo "\nChecking Node status:"
    kubectl get nodes -o wide
  become_user: "{{ ansible_user }}"
  become: false
  register: cni_status
  changed_when: false
